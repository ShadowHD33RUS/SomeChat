<!doctype html>
<html>
	<head>
		<title>СУПИР ЧАТ</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="/style/im.css">

		<script src="/socket.io/socket.io.js"></script>
		<script src="/js/moment/min/moment.min.js"></script>
		<script src="http://code.jquery.com/jquery-3.1.0.min.js"></script>
		<script>
		
		var discon = false;
		var myname = false;
		var global_input_height = false;
		var user_list_width = false;
		var users;
		
		
		//var notif = notification();
		//
		//if (/*@cc_on!@*/false) { // check for Internet Explorer
		//	document.onfocusin = onFocus;
		//	document.onfocusout = onBlur;
		//} else {
		//	window.onfocus = onFocus;
		//	window.onblur = onBlur;
		//}
		
		$(document).ready(function(){
			var socket = io();
				global_input_height = $('#global-input').height();
				user_list_width = $('#user-list').width();
			var users_list = $('#user-list').children().children();
		 
			if (!myname){ // если имя пустое (false по-умолчанию), то выдается это сообщение
				systemMessage('notification','Чтобы войти в чат, введите Ваш ник (в одно слово)');
			}
			
			$('form').submit(function () {
				/* Отправка сообщения от клиента на сервер.
				* Если пользователь первый раз подключился к серверу, то ему предлагается
				* ввести его имя на сервере.
				* 
				* Все сообщения пользователя не принимаются с сервера, а добавляются оффлайн
				* Сообщение не отправится, если поле ввода было пустым.
				* 
				* Если при этом у пользователя не указан его ник, то считается, что сообщение первое.
				* В таком случае сообщение рассматривается как ник. Ник строится по условию:
				* Только одно слово (без пробелов), не длиннее 16 символов.
				* 
				*/
				
				global_input_height = $('#global-input').height();
				user_list_width = $('#user-list').width();
				
				msg = $('#m').val();
				
				if (msg!=''){
					if (!myname){
						myname = msg.split(' ',1)[0].slice(0,16);
						socket.emit('chat message', myname);
						systemMessage('notification','Теперь Ваш ник - ' + myname);
					} else {
						socket.emit('chat message', msg);
						chatMessage(myname, msg);
					}
						$('#m').val('');
				} else {
					systemMessage('critical','Вы забыли ввести сообщение.');
				}
				return false;
			});
			
			socket.on('connect', function (msg) {
				/* Реакция на подключение к серверу.
				* В случае, если пользователь не был причастен к отключению от сервера,
				* выводится сообщение о успешном восстановлении подключения.
				* 
				*/
				if (discon) {
					systemMessage('accept','Связь с сервером восстановлена!');
					discon = false;
					if (myname){
						socket.emit('chat message', myname);
						systemMessage('notification','Ваш ник "' + myname + '" восстановлен!');
					}
				}
			});
			
			socket.on('chat message', function (msg) {
				/* Принимает сообщения для глобального чата.
				 * Сообщение msg является объектом, где:
				 * 	username - имя пользователя, которым он представился;
				 * 	text - текст сообщения от пользователя
				 * 
				 */
				
				notif(); // уведомление о сообщении пользователя
				chatMessage(msg.username,msg.text);
			});
			
			socket.on('system message', function (msg) {
				/* Выводит уведомление, полученное с сервера.
				 * 
				 */
				systemMessage('notification',msg);
			});
			
			socket.on('critical message', function (msg) {
				/* Выводит критическое сообщение, полученное с сервера.
				 * 
				 */
				systemMessage('critical',msg);
			});
			
			socket.on('disconnect', function (msg) {
				/* Выводит сообщение о разрыве связи с сервером.
				 * 
				 */
				systemMessage('critical','Отключен от сервера.');
				discon = true;
				//myname = false;
			});
			
			socket.on('user list', function (msg) {
				/* Обновляет список активных пользователей.
				 * 
				 * TODO: сделать не циклом-костылем
				 * 
				 */
				//users_list.eq(0) // шапка в окне пользователей
				for (var i=1; i<users_list.length; i++){
					users_list.eq(i).remove();
				}
				for (var i=0; i<msg.length; i++){
					users_list.after($('<li>').text(msg[i]));
				}
				
				users_list = $('#user-list').children().children();
				
				
			});
			
			/*$(window).resize( function () {
				/* Функция следит за тем, чтобы при изменениях размера окна браузера
				 * блоки были растянуты на всё пространство.
				 * 
				 * Высота блока для ввода сообщения принята за 50px.
				 * 
				 *
			
				fullScreen();
				chatScroll();
			});*/
			
			//fullScreen();
			
			
		//END $(document).ready(function())
		});
		 
		function systemMessage(type, msg){
			/* Функция вставки системных сообщений.
			 * Имеют сплошную заливку.
			 * Вид: [ВРЕМЯ] СООБЩЕНИЕ
			 * 
			 * Возможные значения параметра type:
			 * critical - сообщение об ошибке
			 * accept - сообщение об успешном выполнении действия
			 * notification - любое другое уведомление.
			 * 
			 */
			msg = '[' + getTime() + '] ' + msg;
			$('#messages').append($('<li>').text(msg).addClass('system '+type));
			
			chatScroll();
		}
		
		//$(window).resize( function () { $('#main-div').children().height($(window).height()-40); });
		 
		function chatMessage(user, msg){
			/* Функция вставки сообщений от пользователей.
			 * 
			 * Вид: [ВРЕМЯ] ИМЯ_ПОЛЬЗОВАТЕЛЯ: СООБЩЕНИЕ
			 * 
			 */
			var time = '[' + getTime() + '] ' + user + ': ';
			//$('#messages').append($('<li>').append($('<span>').addClass('time').text('[' + getTime() + ' | ' + user + '] ')).text(msg));
			$('#messages').append($('<li>')
			.append($('<span>').text(time).addClass('time'))
			.append($('<span>').text(msg)));
			
			chatScroll();
		}
		 
		function getTime(){
			/* Функция просто возвращает время в одном формате для всех сообщений.
			 * 
			 */
			return moment().format('DD-MM-YYYY HH:mm:ss');
		}
		
		function fullScreen(){
			/* Изменяет параметры блоков для корректного растягивания их на весь экран.
			 * 
			 * TODO: запилить поддержку телефонов.
			 * 
			 */
			
			var h=$(window).height() - global_input_height;
			var w=$(window).width() - user_list_width;
			$('#chat-div').height(h).width(w);//.scrollTop(h);
			$('#user-list').height(h)
			
		}
		
		function chatScroll(){
			/* Необходимо для прокрутки блока чата до конца.
			 * Используется при изменении размера браузера или при получении нового сообщения.
			 * 
			 */
			
			var temp_cd = $('#chat-div').children()
			var chatScrollTop = $('#messages').height()-temp_cd.height();
			if (chatScrollTop > 0) {
				temp_cd.scrollTop(chatScrollTop);
			}
		}
		
		function notif(){
			/* Занимается уведомлениями.
			 * 
			 */
			
			$('#notification-sound')[0].play();
		}
		
		</script>


	</head>
	<body>
		<audio id="notification-sound" preload="auto">
			<source src="sound/knob.ogg" type="audio/ogg" >
			<source src="sound/knob.mp3" type="audio/mp3" >
		</audio>
		
		<div id="chat-div" class="chat-div"><div><ul id="messages">
			</ul></div>
		</div><div id="user-list" class="user-list"><ul>
				<li class="user-list-header">АКТИВНЫЕ ПОЛЬЗОВАТЕЛИ</li>
			</ul>
		</div><div id="global-input" class="global-input">
			<form action="">
				<input id="m" autocomplete="off" placeholder="Ваше сообщение..."><button class="send-button">Отправить</button>
			</form>
		</div>
		

		
	</body>
</html>